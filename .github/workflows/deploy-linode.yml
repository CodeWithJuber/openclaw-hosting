name: Dynamic Deployment to Linode

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LINODE_SSH_KEY }}
      
      - name: Add host to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.LINODE_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to Linode
        env:
          LINODE_HOST: ${{ secrets.LINODE_HOST }}
          DEPLOY_ENV: ${{ github.event.inputs.environment || 'staging' }}
        run: |
          echo "ðŸš€ Deploying to $DEPLOY_ENV environment..."
          
          # Create deployment script
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          DEPLOY_ENV=$1
          echo "=== OpenClaw Hosting Deployment ==="
          echo "Environment: $DEPLOY_ENV"
          echo "Time: $(date)"
          
          # Navigate to app directory
          cd /opt/openclaw-hosting || exit 1
          
          # Pull latest code
          git pull origin master
          
          # Create environment file
          if [ "$DEPLOY_ENV" = "production" ]; then
            cp .env.production .env
          else
            cp .env.staging .env
          fi
          
          # Deploy with Docker
          docker-compose -f docker-compose.prod.yml down
          docker-compose -f docker-compose.prod.yml pull
          docker-compose -f docker-compose.prod.yml up -d
          
          # Health check
          sleep 10
          curl -f http://localhost:2222/health || exit 1
          
          echo "âœ… Deployment successful!"
          EOF
          
          # Copy and execute deployment script
          scp deploy.sh root@$LINODE_HOST:/tmp/deploy.sh
          ssh root@$LINODE_HOST "chmod +x /tmp/deploy.sh && /tmp/deploy.sh $DEPLOY_ENV"
      
      - name: Health Check
        env:
          LINODE_HOST: ${{ secrets.LINODE_HOST }}
        run: |
          echo "ðŸ¥ Running health checks..."
          sleep 15
          curl -f http://$LINODE_HOST:2222/health || exit 1
          echo "âœ… Health check passed!"
      
      - name: Notify Deployment
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ðŸŽ‰ Deployment completed successfully!"
          else
            echo "âŒ Deployment failed!"
          fi
